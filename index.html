<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>One market</title>
  <link rel="icon" type="image/svg+xml" href="logo.svg">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="theme.css">
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="responsive.css">
</head>
<body>
  <!-- ===== Header ===== -->
  <header>
    <div class="site-brand">
      <div class="brand-mark">
        <img src="logo.svg" alt="شعار One market" class="brand-logo">
      </div>
      <div class="brand-text">
        <h1>One market</h1>
        <p>خضار طازة يومياً — اختار منتجاتك بنفسك</p>
      </div>
    </div>
    <nav class="site-nav">
      <a href="index.html">الرئيسية</a>
      <a href="shop.html">المتجر</a>
      <a href="about.html">عن المتجر</a>
      <a href="checkout.html">الدفع</a>
      <a href="orders.html">طلباتي</a>
      <a href="cart.html">العربة</a>
    </nav>
    <a href="cart.html" class="cart-icon-header" aria-label="العربة">
      <span class="cart-icon">🛒</span>
      <span class="cart-count" id="cartCount">0</span>
    </a>
  </header>

  <!-- ===== Main Container ===== -->
  <div class="container">
    <section class="products-showcase">
      <h2 class="section-title">✨ اختار منتجاتك</h2>
      
      <div id="productsGrid" class="products-grid-v2" aria-live="polite"></div>
      <p id="productsEmpty" class="products-empty" hidden>لا توجد منتجات متاحة حالياً.</p>
    </section>

    <a id="quickCartBtn" class="quick-cart-btn" href="cart.html" aria-label="اذهب للعربة">
      <span class="quick-cart-label">اذهب للعربة</span>
      <span id="quickCartCount" class="quick-cart-count">0</span>
    </a>

    <a class="whatsapp-help" href="https://wa.me/201067465207" target="_blank" rel="noopener" style="display:block;text-align:center;margin:16px auto;padding:10px 14px;background:#25D366;color:#fff;border-radius:12px;max-width:340px;font-weight:700;">
      💬 تواصل مع خدمة العملاء واتساب: 01067465207
    </a>
  </div>

  <!-- Scripts in order: config → utils → main -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script>
    (() => {
      const PRODUCT_IMAGE_MAP = Object.freeze({
        tomato: 'tomato.png',
        bell_pepper: 'filfil.png'
      });

      const PRODUCT_BADGE_MAP = Object.freeze({
        strawberry: '15% off'
      });

      const FEATURED_ORDER = Object.freeze([
        'tomato', 'banana', 'potato', 'strawberry',
        'white_onion', 'red_onion', 'cucumber', 'zucchini',
        'carrot', 'bell_pepper', 'apple', 'orange',
        'grapes', 'mango'
      ]);

      const STEP_BY_UNIT = Object.freeze({
        'كجم': 0.5,
        'حبة': 1,
        'حزمة': 1,
        'وحدة': 1
      });

      const quantities = {};
      const expandedEditors = {};
      const collapseTimers = {};
      const COLLAPSE_DELAY_MS = 3000;

      function getStep(unit) {
        return STEP_BY_UNIT[unit] || 1;
      }

      function normalizeQty(value) {
        const num = Number(value);
        if (!Number.isFinite(num) || num <= 0) return 0;
        return Number(num.toFixed(2));
      }

      function formatQty(qty, unit) {
        const formatted = Number.isInteger(qty)
          ? String(qty)
          : String(Number(qty.toFixed(2))).replace(/\.0+$/, '').replace(/(\.\d*[1-9])0+$/, '$1');
        return `${formatted} ${unit}`;
      }

      function formatQtyBubble(qty) {
        return Number.isInteger(qty)
          ? String(qty)
          : String(Number(qty.toFixed(2))).replace(/\.0+$/, '').replace(/(\.\d*[1-9])0+$/, '$1');
      }

      function clearCollapseTimer(productId) {
        const timerId = collapseTimers[productId];
        if (!timerId) return;
        clearTimeout(timerId);
        delete collapseTimers[productId];
      }

      function scheduleCollapse(productId) {
        clearCollapseTimer(productId);

        if (!expandedEditors[productId]) return;
        if (normalizeQty(quantities[productId] || 0) <= 0) return;

        collapseTimers[productId] = setTimeout(() => {
          const currentQty = normalizeQty(quantities[productId] || 0);
          if (currentQty <= 0) return;

          delete expandedEditors[productId];

          const card = document.querySelector(`.market-product-card[data-product="${productId}"]`);
          if (card) updateCardState(card, currentQty);
        }, COLLAPSE_DELAY_MS);
      }

      function setEditorExpanded(productId, expanded) {
        if (expanded && normalizeQty(quantities[productId] || 0) > 0) {
          expandedEditors[productId] = true;
          scheduleCollapse(productId);
          return;
        }

        delete expandedEditors[productId];
        clearCollapseTimer(productId);
      }

      function formatPriceParts(value) {
        const amount = Number(value);
        if (!Number.isFinite(amount) || amount <= 0) return null;
        const [major, minor] = amount.toFixed(2).split('.');
        return { major, minor };
      }

      function getUnitHint(unit) {
        if (unit === 'كجم') return 'يباع بالكيلو';
        if (unit === 'حبة') return 'يباع بالحبة';
        if (unit === 'حزمة') return 'يباع بالحزمة';
        if (unit === 'وحدة') return 'يباع بالوحدة';
        return 'سعر الوحدة';
      }

      function featuredRank(id) {
        const idx = FEATURED_ORDER.indexOf(id);
        return idx === -1 ? Number.MAX_SAFE_INTEGER : idx;
      }

      function pruneUnavailableQuantities() {
        Object.keys(quantities).forEach(productId => {
          const price = Number(PRODUCTS?.[productId]?.unitPrice);
          if (!Number.isFinite(price) || price <= 0) {
            delete quantities[productId];
            setEditorExpanded(productId, false);
          }
        });
      }

      function getStoredItems() {
        const saved = loadPackageFromStorage();
        if (!saved || !saved.items) return {};

        const parsed = {};
        Object.entries(saved.items).forEach(([productId, qty]) => {
          if (!PRODUCTS[productId]) return;
          const normalized = normalizeQty(qty);
          if (normalized > 0) {
            parsed[productId] = normalized;
          }
        });

        return parsed;
      }

      function getAvailableProducts() {
        return Object.entries(PRODUCTS)
          .filter(([, product]) => {
            const price = Number(product?.unitPrice);
            return Number.isFinite(price) && price > 0;
          })
          .sort(([idA, productA], [idB, productB]) => {
            const rankDiff = featuredRank(idA) - featuredRank(idB);
            if (rankDiff !== 0) return rankDiff;
            return String(productA.name || '').localeCompare(String(productB.name || ''), 'ar');
          });
      }

      function selectedItems() {
        const items = {};
        Object.entries(quantities).forEach(([productId, qty]) => {
          const price = Number(PRODUCTS?.[productId]?.unitPrice);
          const normalized = normalizeQty(qty);
          if (normalized > 0 && Number.isFinite(price) && price > 0) {
            items[productId] = normalized;
          }
        });
        return items;
      }

      function calculateTotal(items) {
        return Object.entries(items).reduce((sum, [productId, qty]) => {
          const price = Number(PRODUCTS?.[productId]?.unitPrice);
          if (!Number.isFinite(price) || price <= 0) return sum;
          return sum + (price * qty);
        }, 0);
      }

      function updateCartCount() {
        const countEl = document.getElementById('cartCount');
        const quickBtn = document.getElementById('quickCartBtn');
        const quickCountEl = document.getElementById('quickCartCount');
        const itemsCount = Object.keys(selectedItems()).length;

        if (countEl) countEl.textContent = String(itemsCount);

        if (quickCountEl) quickCountEl.textContent = String(itemsCount);
        if (quickBtn) quickBtn.classList.toggle('has-items', itemsCount > 0);
      }

      function saveCurrentSelection() {
        pruneUnavailableQuantities();

        const items = selectedItems();
        if (!Object.keys(items).length) {
          Object.keys(expandedEditors).forEach(productId => setEditorExpanded(productId, false));
          clearPackageFromStorage();
          updateCartCount();
          return;
        }

        const basePackage = PACKAGES?.week || {};
        const packageData = {
          id: basePackage.id || 'week',
          name: 'طلب مخصص',
          emoji: '🛒',
          frequency: basePackage.frequency || 'أسبوعي',
          deliveryDays: Number(basePackage.deliveryDays) || 7,
          items,
          price: Number(calculateTotal(items).toFixed(2)),
          isRecurring: false,
          createdAt: new Date().toISOString()
        };

        savePackageToStorage(packageData);
        updateCartCount();
      }

      function buildCard(productId, product) {
        const qty = normalizeQty(quantities[productId] || 0);
        const unit = product.unit || 'وحدة';
        const priceParts = formatPriceParts(product.unitPrice);
        const badge = PRODUCT_BADGE_MAP[productId]
          ? `<span class="product-discount-badge">${PRODUCT_BADGE_MAP[productId]}</span>`
          : '';

        const imagePath = PRODUCT_IMAGE_MAP[productId];
        const visual = imagePath
          ? `<img class="market-product-image" src="${imagePath}" alt="${product.name}" loading="lazy">`
          : `<span class="market-product-emoji" aria-hidden="true">${product.emoji || '🧺'}</span>`;

        const priceHtml = priceParts
          ? `<div class="product-price-row-v2">
              <span class="price-major">${priceParts.major}</span>
              <span class="price-minor">.${priceParts.minor}</span>
              <span class="price-currency">EGP</span>
            </div>`
          : `<div class="product-price-row-v2 unavailable">غير متوفر</div>`;

        return `
          <article class="market-product-card" data-product="${productId}" data-unit="${unit}">
            <div class="market-product-media">
              ${badge}
              ${visual}
              <button type="button" class="product-add-btn" data-action="add" data-product="${productId}" aria-label="إضافة ${product.name}">
                <span class="add-icon" data-role="add-icon">+</span>
                <span class="add-qty" data-role="add-qty" hidden></span>
              </button>

              <div class="product-qty-bar" hidden>
                <button type="button" class="qty-clear-btn" data-action="clear" data-product="${productId}" aria-label="حذف ${product.name}">🗑</button>
                <span class="qty-value" data-role="qty-value">${formatQty(Math.max(qty, getStep(unit)), unit)}</span>
                <button type="button" class="qty-plus-btn" data-action="increase" data-product="${productId}" aria-label="زيادة ${product.name}">+</button>
              </div>
            </div>

            <h3 class="market-product-name">${product.name}</h3>
            <p class="market-product-meta">${getUnitHint(unit)}</p>
            ${priceHtml}
          </article>
        `;
      }

      function updateCardState(card, qty) {
        const productId = card.dataset.product;
        const addBtn = card.querySelector('.product-add-btn');
        const qtyBar = card.querySelector('.product-qty-bar');
        const qtyValue = card.querySelector('[data-role="qty-value"]');
        const addQty = card.querySelector('[data-role="add-qty"]');
        const unit = card.dataset.unit || 'وحدة';
        const expanded = !!expandedEditors[productId] && qty > 0;

        if (qty <= 0) {
          setEditorExpanded(productId, false);
        }

        if (expanded) {
          if (addBtn) addBtn.hidden = true;
          if (qtyBar) qtyBar.hidden = false;
          if (qtyValue) qtyValue.textContent = formatQty(qty, unit);
        } else {
          if (addBtn) addBtn.hidden = false;
          if (qtyBar) qtyBar.hidden = true;
        }

        if (addBtn && addQty) {
          if (qty > 0) {
            addBtn.classList.add('has-qty');
            addQty.hidden = false;
            addQty.textContent = formatQtyBubble(qty);
          } else {
            addBtn.classList.remove('has-qty');
            addQty.hidden = true;
            addQty.textContent = '';
          }
        }
      }

      function renderProducts() {
        const grid = document.getElementById('productsGrid');
        const emptyEl = document.getElementById('productsEmpty');
        if (!grid) return;

        const available = getAvailableProducts();

        if (!available.length) {
          grid.innerHTML = '';
          if (emptyEl) emptyEl.hidden = false;
          updateCartCount();
          return;
        }

        if (emptyEl) emptyEl.hidden = true;
        grid.innerHTML = available.map(([productId, product]) => buildCard(productId, product)).join('');

        grid.querySelectorAll('.market-product-card').forEach(card => {
          const productId = card.dataset.product;
          updateCardState(card, normalizeQty(quantities[productId] || 0));
        });

        if (!grid.dataset.bound) {
          grid.addEventListener('click', handleProductAction);
          grid.dataset.bound = 'true';
        }
      }

      function handleProductAction(event) {
        const button = event.target.closest('button[data-action]');
        if (!button) return;

        const card = button.closest('.market-product-card');
        if (!card) return;

        const productId = card.dataset.product;
        if (!productId || !PRODUCTS[productId]) return;

        const unit = card.dataset.unit || PRODUCTS[productId].unit || 'وحدة';
        const step = getStep(unit);
        const currentQty = normalizeQty(quantities[productId] || 0);
        const action = button.dataset.action;

        if (action === 'add' && currentQty > 0) {
          setEditorExpanded(productId, true);
          updateCardState(card, currentQty);
          return;
        }

        let nextQty = currentQty;
        if (action === 'add' || action === 'increase') {
          nextQty = normalizeQty(action === 'add' ? step : currentQty + step);
        } else if (action === 'clear') {
          nextQty = 0;
        }

        if (nextQty > 0) {
          quantities[productId] = nextQty;
          setEditorExpanded(productId, true);
        } else {
          delete quantities[productId];
          setEditorExpanded(productId, false);
        }

        updateCardState(card, nextQty);
        saveCurrentSelection();
      }

      async function initProductsPage() {
        const stored = getStoredItems();
        Object.assign(quantities, stored);

        try {
          await loadProductPrices();
        } catch (err) {
          console.warn('تعذر جلب الأسعار:', err);
        }

        pruneUnavailableQuantities();
        renderProducts();
        saveCurrentSelection();
      }

      document.addEventListener('DOMContentLoaded', initProductsPage);
      document.addEventListener('prices:updated', () => {
        pruneUnavailableQuantities();
        renderProducts();
        saveCurrentSelection();
      });
    })();
  </script>
  <script src="js/main.js"></script>
</body>
</html>

